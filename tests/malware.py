# Malware recognition tests

from pathlib import Path
from email.mime.application import MIMEApplication
from .base import MailAttachmentTestBase

class EICARMalwareTest(MailAttachmentTestBase):
    active = True
    identifier = "eicar"
    name = "EICAR Test File"
    description = "Attach EICAR test file"
    subject = "EICAR - {}"
    extensions = ("com", "exe", "txt", "html")
    file_name = "eicar.{}"
    file_content = "X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*"

    def generateAttachments(self):
        for extension in self.extensions:
            attachment = MIMEApplication(self.file_content)
            attachment.add_header("Content-Disposition", "attachment", filename=self.file_name.format(extension))
            final_attachments = self.evasions["content_disposition"].getEvasionGenerator(attachment, self.file_name.format(extension))
            for ev_desc, final_attachment in final_attachments.generate():
                yield "{} {}".format(extension, ev_desc), final_attachment

class MalwareSamplesAttachmentTest(MailAttachmentTestBase):
    active = True
    identifier = "malware"
    name = "Malware Samples"
    description = "Send malware sample files as attachments from folders given by --malware-folder parameter"
    subject = "Malware - {}"

    def generateAttachments(self):
        for folder in self.args.malware_folder:
            for sample in Path(folder).iterdir():
                attachment = MIMEApplication(sample.read_bytes())
                final_attachments = self.evasions["content_disposition"].getEvasionGenerator(attachment, sample.name)
                for ev_desc, final_attachment in final_attachments.generate():
                    yield "{} {}".format(sample.name, ev_desc), final_attachment
